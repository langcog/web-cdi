{% load i18n cdiform_tags %}
{% to_list 'Dutch' as language_list %}
{% if 'WG' in instrument or 'L1' in instrument %}
    {% set_true as show_produced %}
{% else %}
    {% set_false as show_produced %}
{% endif %}

<html lang="en">
<head>
    <meta charset="utf-8">
    {% load static %}

    <title>{% trans title %}</title>
    <meta name="description" content="MacArthur-Bates Communicative Development Inventory">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" ></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>

    <link rel="stylesheet" href="{% static 'bootstrap/bootstrap.min.css' %}">
    <script src="{% static 'bootstrap/bootstrap.min.js' %}"></script>
    <script src="{% static 'cdi_forms/selectize.js' %}"></script>
    <script src="{% static 'cdi_forms/bootstrap-datepicker.js' %}"></script>
    <link rel='stylesheet' href="{% static 'cdi_forms/selectize.bootstrap3.css' %}">
    <link rel='stylesheet' href="{% static 'cdi_forms/datepicker.css' %}">
    <link rel="stylesheet" href="{% static 'cdi_forms/docs.min.css' %}" />
    <link rel='stylesheet' href="{% static 'cdi_forms/base.css' %}">
    <script src="{% static 'd3/d3.v3.js' %}"></script>
    <script src="{% static 'lodash/lodash.min.js' %}"></script>
    <script src="{% static 'd3/d3-queue.min.js' %}"></script>

    <link rel="stylesheet" href="{% static 'd3/c3.css' %}">
    <script src="{% static 'd3/c3.min.js' %}"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  	<meta property="og:image" content="http://webcdi.stanford.edu/{% static 'researcher_UI/images/logo.png' %}" />
  	<meta property="og:title" content="{% trans 'MacArthur-Bates Communicative Development Inventory' %}" />
  	<meta property="og:description" content="{% trans 'Interesting tidbits learned from how your child speaks!' %}" />

    <script src="{% static 'jquery/jquery-1.11.3.min.js' %}"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        {% for category in graph_data %}
            console.log("{{ category }}", "{{ graph_data|get_item:category }}", "{{ graph_data|get_item:category|get_item:'mappedName' }}")
        {% endfor %}

        // Load the Visualization API and the corechart package.
        google.charts.load("current", {packages:["corechart"]});

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawProducesChart);
        google.charts.setOnLoadCallback(drawProducesChart2);

        var graph_colors = [
            "#ff0000","#cc0066","#cc0099","#9933ff",'#3333cc','#0033cc','#0099cc','#009999','#00cc66','#009933','#669900','#cccc00','#ff9900','#ff3300',
            '#ff0000','#cc0066','#cc0099','#9933ff','#3333cc','#0033cc','#0099cc','#009999','#00cc66','#009933','#669900','#cccc00','#ff9900','#ff3300',
            '#ff0000','#cc0066','#cc0099','#9933ff','#3333cc','#0033cc','#0099cc','#009999','#00cc66','#009933','#669900','#cccc00','#ff9900','#ff3300',
            '#ff0000','#cc0066','#cc0099','#9933ff','#3333cc','#0033cc','#0099cc','#009999','#00cc66','#009933','#669900','#cccc00','#ff9900','#ff3300'];
      // Callback that creates and populates a data table,
      // instantiates the pie chart, passes in the data and
      // draws it.
      function drawProducesChart() {

        // Create the data table.
        var data = new google.visualization.arrayToDataTable([
            ['Category','Percentage', {role: 'style'}],
            {% for category in graph_data %}
                {% if graph_data|get_item:category|get_item:'count' > 0 %}
                ['{{ graph_data|get_item:category|get_item:'mappedName' }}', {{ graph_data|get_item:category|get_item_perc:'produces' }}, graph_colors[{{ forloop.counter0 }}]],
                {% endif %}                
            {% endfor %}
        ]);
        
        // Set chart options
        var options = {
            'title': '{% trans 'Words Produced in Category (%)' %}',
            'width' : 550,
            'height':750,
            'legend': {position: 'none'},
            'vAxis' : { textStyle : { fontSize: 10} },
            'hAxis' : {viewWindow: { min:0 }},
            };

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.BarChart(document.getElementById('categories_charts_produced'));

        var btnProducedSave = document.getElementById('save-produced-pdf')
        google.visualization.events.addListener(chart, 'ready', function () {
            btnProducedSave.disabled = false;
        });
        btnProducedSave.addEventListener('click', function () {
            var doc = new jsPDF();
            doc.addImage(chart.getImageURI(), 0, 0);
            doc.save('chart.pdf');
        }, false);

        chart.draw(data, options);
      }

    function drawProducesChart2() {

        // Create the data table.
        var data = new google.visualization.arrayToDataTable([
            ['Category','Percentage', {role: 'style'}],
            {% for category in graph_data %}
                {% if graph_data|get_item:category|get_item:'count' > 0 %}
                ['{{ graph_data|get_item:category|get_item:'mappedName' }}', {{ graph_data|get_item:category|get_item_count:'produces'|get_usage_perc:totals.produces }}, graph_colors[{{ forloop.counter0 }}]],
                {% endif %}                
            {% endfor %}
        ]);

        // Set chart options
        var options = {
            'title': '{% trans 'Words Produced for Child (%)' %}',
            'width' : 550,
            'height':750,
            'legend': {position: 'none'},
            'vAxis' : { textStyle : { fontSize: 10} },
            'hAxis' : {viewWindow: { min:0 }},
            };

            // Instantiate and draw our chart, passing in some options.
            var chart = new google.visualization.BarChart(document.getElementById('categories_charts_produced2'));

        var btnProducedSave = document.getElementById('save-produced2-pdf')
        google.visualization.events.addListener(chart, 'ready', function () {
            btnProducedSave.disabled = false;
        });
        btnProducedSave.addEventListener('click', function () {
            var doc = new jsPDF();
            doc.addImage(chart.getImageURI(), 0, 0);
            doc.save('chart.pdf');
        }, false);

        chart.draw(data, options);
    }
    
        {% if show_produced or language in language_list  %}
            google.charts.setOnLoadCallback(drawUnderstoodChart);
            google.charts.setOnLoadCallback(drawUnderstoodChart2);
            function drawUnderstoodChart() {

                // Create the data table.
                var data = new google.visualization.arrayToDataTable([
                    ['Category','Percentage', {role: 'style'}],
                    {% for category in graph_data %}
                        {% if graph_data|get_item:category|get_item:'count' > 0 %}
                        ['{{ graph_data|get_item:category|get_item:'mappedName' }}', {{ graph_data|get_item:category|get_item_perc:'understands' }}, graph_colors[{{ forloop.counter0 }}]],
                        {% endif %}                
                    {% endfor %}                    
                ]);

                // Set chart options
                var options = {
                    'title': '{% trans 'Words Understood in Category(%)' %}',
                    'width':550,
                    'height':750,
                    'legend': {position: 'none'},
                    'vAxis' : { textStyle : { fontSize: 10} },
                    'hAxis' : {viewWindow: { min:0 }},
                    };

                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.BarChart(document.getElementById('categories_charts_understood'));

                var btnUnderstoodSave = document.getElementById('save-understood-pdf')
                google.visualization.events.addListener(chart, 'ready', function () {
                    btnUnderstoodSave.disabled = false;
                });
                btnUnderstoodSave.addEventListener('click', function () {
                    var doc = new jsPDF();
                    doc.addImage(chart.getImageURI(), 0, 0);
                    doc.save('chart.pdf');
                }, false);
                
                chart.draw(data, options);
            }

            function drawUnderstoodChart2() {
                // Create the data table.
                var data = new google.visualization.arrayToDataTable([
                    ['Category','Percentage', {role: 'style'}],
                    {% for category in graph_data %}
                        {% if graph_data|get_item:category|get_item:'count' > 0 %}
                        ['{{ graph_data|get_item:category|get_item:'mappedName' }}', {{ graph_data|get_item:category|get_item_count:'understands'|get_usage_perc:totals.understands }}, graph_colors[{{ forloop.counter0 }}]],
                        {% endif %}                
                    {% endfor %}                    
                ]);

                // Set chart options
                var options = {
                    'title': '{% trans 'Words Understood for Child (%)' %}',
                    'width':550,
                    'height':750,
                    'legend': {position: 'none'},
                    'vAxis' : { textStyle : { fontSize: 10} },
                    'hAxis' : {viewWindow: { min:0 }},
                    };

                // Instantiate and draw our chart, passing in some options.
                var chart = new google.visualization.BarChart(document.getElementById('categories_charts_understood2'));

                var btnUnderstoodSave = document.getElementById('save-understood2-pdf')
                google.visualization.events.addListener(chart, 'ready', function () {
                    btnUnderstoodSave.disabled = false;
                });
                btnUnderstoodSave.addEventListener('click', function () {
                    var doc = new jsPDF();
                    doc.addImage(chart.getImageURI(), 0, 0);
                    doc.save('chart.pdf');
                }, false);

                chart.draw(data, options);
                }
        {% endif %}
    </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=328947117"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', '328947117');
        </script>
</head>

<body id="id_results">
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.8";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="container bs-docs-container" style='padding-top: 60px; padding-bottom: 60px;'>
    <form class='form-horizontal'>
        {% csrf_token %}
        <div class = "col-md-12">
        <!-- Thank you letter written to participants upon completion with the CDI logo. If participant is meant to be compensated, letter will also include a gift card code, monetary amount, and instructions on how to redeem the gift card. -->
            <div class="row">
                <div class="col-lg-4 col-8 mx-auto">
                    <img src={% static 'images/logo_bg.jpg' %} class="rounded mx-auto d-block" alt="{% trans 'MB-CDI Lab Logo' %}" style="width: 100%"> <br>
                </div>
            </div>
            {% if object.study.end_message == 'standard' or object.study.end_message == 'combined' %}            
            <div class="row">

                <h2>{% trans "Thank you!" %} </h2><br>
                <h1>{% for i in instrument_list%}{{ i }} X {% endfor %}</h1>
                <h4>
                    {% blocktrans %}Thank you for taking the time to complete the MacArthur-Bates Communicative Development Inventory (CDI). With the help of parents and caregivers like you, we are working to learn more about the way that children’s language develops, and how that development varies across individual children and cultures. Remember that the CDI lists many different words that are used by many different children. Don’t worry if your child only knows a few of them right now. Below are some insights into your child’s developing vocabulary, based on our research. This summary is not a clinical evaluation. If you have any concerns about your child’s development, we recommend that you talk with your child’s physician. If you enjoyed our assessment, you can learn more about the CDI <a href="http://mb-cdi.stanford.edu/" target="_blank">here</a>. We appreciate your contribution!{% endblocktrans %}
                </h4>

                {% if gift_code %}
                <br>
                    {% if gift_code == 'ran out' %}
                        <h4>
                            {% blocktrans with contact_url=contact_url %}We're sorry but it looks like we have run out of Amazon.com Gift Cards! Please <a href="{{ contact_url }}" target="_blank">reach out to us</a> and we will quickly fix this issue.{% endblocktrans %}
                        </h4>
                    {% else %}
                        <h4>
                        <p>
                            {% blocktrans %}Thank you for participating in our Web-CDI project! It is our pleasure to send you this Amazon.com Gift Card that can be redeemed towards millions of items at <a href="http://www.amazon.com" target="_blank">www.amazon.com</a>. You may want to print this screen for easy reference later--you’ll need the gift card claim code below.{% endblocktrans %}
                        </p>

                        <p>
                            {% trans "Gift Card Amount" %}: {{ gift_amount }}  <br>
                            {% trans "Claim Code" %}: {{ gift_code }}
                        </p>

                        <p>
                            {% blocktrans with redeem_url=redeem_url legal_url=legal_url %}To redeem your gift card, visit <a href="{{ redeem_url }}" target="_blank">www.amazon.com/redeem</a>. Restrictions apply, see <a href="{{ legal_url }}" target="_blank">www.amazon.com/gc-legal</a>.{% endblocktrans %}
                 
                        </p>
                        </h4>
                 
                    {% endif %}
                                
                {% endif %}

                <br><br>
            </div>
            {% endif %}
            {% if object.study.end_message == 'bespoke' or object.study.end_message == 'combined' %}
                <div class="row">
                    {{ object.study.end_message_text|safe }}
                </div>
            {% endif %}
            <br>

        </div>

        {% if show_feedback %}
            <!-- Button triggers the D3 graph div to appear. -->
            <div class="row justify-content-center" style="padding-bottom: 1%;">
                <a class="btn btn-primary btn-lg active" href="#graph_data" data-toggle="collapse">{% trans "Graph My Data!" %}</a>
            </div>
        {% endif %}

        <!-- Text triggers the submitted answers div to appear -->
        <div class="row justify-content-center">
            <h4><a href="#filled_form" data-toggle="collapse">{% trans "Show Me My Answers" %}</a></h4>
        </div>
        {% if object.study.print_my_answers_boolean %}
        <div class="row justify-content-center">
            <h4><a href="{% url 'administration-pdf-view' object.pk %}">{% trans "Print My Answers" %}</a></h4>
        </div>
        {% endif %}
        {% if object.study.redirect_boolean %}
        <div class="row justify-content-center">
            <h4><a class="btn btn-danger btn-lg active" href="{{ object.redirect_url }}">{% trans "Click to complete the study" %}</a></h4>
        </div>
        {% endif %}
        

        <div class="row justify-content-center">
            <!-- If study allows participants to share results via Facebook, a link for FB sharing will appear in template. -->
              {% if allow_sharing %}
                {% url 'administer_cdi_form' hash_id=hash_id as form_url %}
                <div class="fb-share-button" data-href="{{ form_url }}" data-layout="link" data-mobile-iframe="false">
                       <a class="fb-xfbml-parse-ignore" target="_blank" style="width: 100%;" href="https://www.facebook.com/sharer/sharer.php?u={{ form_url | urlencode }}&amp;src=sdkpreparse">{% trans "Share on Facebook" %}</a>
                </div>
              {% endif %}
        </div>


        <br>
        {% if show_feedback %}
            <div class="col-md-12 collapse show" id="graph_data" style="height: 90vh;">
                <br>
                <div class = "row"> 
                    <div class="col-md-6 text-center" id="num_words_text"></div>
                    <div class="col-md-6 text-center" id="hardest_words"></div>
                </div>
                <br>
                <div class = "row" style="margin-left:-65px; margin-right:-65px"> 
                    {% if show_produced or language in language_list %}
                        <div class="col-md-6 text-center">
                            <div id="categories_charts_understood"></div>
                            <input id="save-understood-pdf" type="button" value="{% trans 'Save as PDF' %}" disabled />
                        </div>
                        <div class="col-md-6 text-center">
                            <div id="categories_charts_understood2"></div>
                            <input id="save-understood2-pdf" type="button" value="{% trans 'Save as PDF' %}" disabled />
                        </div>
                    {% endif %}
                    <div class="col-md-6 text-center">
                        <div id="categories_charts_produced"></div>
                        <input id="save-produced-pdf" type="button" value="{% trans 'Save as PDF' %}" disabled />
                    </div>
                    <div class="col-md-6 text-center">
                        <div id="categories_charts_produced2"></div>
                        <input id="save-produced2-pdf" type="button" value="{% trans 'Save as PDF' %}" disabled />
                    </div>
                </div>
                <br>
                <div class = "row justify-content-center"> 
                    <h4><div id="best_categories" class="text-center"></div></h4>
                </div>
            </div>
        {% endif %}

        <!-- Div for submitted form. Identical to section in cdi_form.html however all inputs are disabled and all answers are displayed on one page. -->
        <div class = "col-md-12 collapse" id="filled_form" role="main" style="padding-top:220px">

            <div class="row">
                {% load crispy_forms_tags %}
                {% crispy background_form %}
                {% if backpage_background_form %}{% crispy backpage_background_form %}{% endif %}
            </div>
            
            {% if parts %}
                <ul>
                    {% include "cdi_forms/cdi_items.html" with parts=parts %}
                </ul>
            {% else %}
                <p>{% trans "Form unavailable. Contact admin." %} </p>
            {% endif %}
        </div>
    </form>
</div>

<!-- Disables all inputs and select options. Renames 'produces' to 'understands and says' -->
<script>
    $('input').prop('disabled', 'True');
    $('select').prop('disabled', 'True');
    $('label.btn').addClass('disabled');

    $( "input[id$='produces']" ).each( function (){ 
        var label_var = $(this).parent().find('span.choice');
        $(label_var).text("understands and says");
    });

    setTimeout(function () {
        $('.fb-share-button span').css('width', '20%');
    }, 200);      
</script>

<script>
    // This is meant to change to RTL
    var layout = {};
    layout.setDirection = function (direction) {
        layout.rtl = (direction === 'rtl');
        document.getElementsByTagName("html")[0].style.direction = direction;
        var styleSheets = document.styleSheets;
        var modifyRule = function (rule) {
            if (rule.style.getPropertyValue(layout.rtl ? 'left' : 'right') && rule.selectorText.match(/\.col-(xs|sm|md|lg)-push-\d\d*/)) {
                rule.style.setProperty((layout.rtl ? 'right' : 'left'), rule.style.getPropertyValue((layout.rtl ? 'left' : 'right')));
                rule.style.removeProperty((layout.rtl ? 'left' : 'right'));
            }
            if (rule.style.getPropertyValue(layout.rtl ? 'right' : 'left') && rule.selectorText.match(/\.col-(xs|sm|md|lg)-pull-\d\d*/)) {
                rule.style.setProperty((layout.rtl ? 'left' : 'right'), rule.style.getPropertyValue((layout.rtl ? 'right' : 'left')));
                rule.style.removeProperty((layout.rtl ? 'right' : 'left'));
            }
            if (rule.style.getPropertyValue(layout.rtl ? 'margin-left' : 'margin-right') && rule.selectorText.match(/\.col-(xs|sm|md|lg)-offset-\d\d*/)) {
                rule.style.setProperty((layout.rtl ? 'margin-right' : 'margin-left'), rule.style.getPropertyValue((layout.rtl ? 'margin-left' : 'margin-right')));
                rule.style.removeProperty((layout.rtl ? 'margin-left' : 'margin-right'));
            }
            if (rule.style.getPropertyValue('float') && rule.selectorText.match(/\.col-(xs|sm|md|lg)-\d\d*/)) {
                rule.style.setProperty('float', (layout.rtl ? 'right' : 'left'));
            }
        };
        try {
            for (var i = 0; i < styleSheets.length; i++) {
                var rules = styleSheets[i].cssRules || styleSheets[i].rules;
                if (rules) {
                    for (var j = 0; j < rules.length; j++) {
                        if (rules[j].type === 4) {
                            var mediaRules = rules[j].cssRules || rules[j].rules
                            for (var y = 0; y < mediaRules.length; y++) {
                                modifyRule(mediaRules[y]);
                            }
                        }
                        if (rules[j].type === 1) {
                            modifyRule(rules[j]);
                        }

                    }
                }
            }
        } catch (e) {
            // Firefox might throw a SecurityError exception but it will work
            if (e.name !== 'SecurityError') {
                throw e;
            }
        }
    }

    if ("{{ language_code }}"=="he") {
        layout.setDirection("rtl")
    }

</script>

</body>
</html>
